<!DOCTYPE HTML>
<html>
  <head>
<style>
body {
	margin: 0px;
	padding: 0px;
}
#container {
	border: 2px dashed #aaa;
}
td>img {
	width: 90px;
	height: auto;
}
#designMoodBoard {
	display:inline;
}
#container, #buttons {
	float: left;
	margin-left:35px;
	margin-top: 35px;
}

#image_menu {
	float: left;
	margin-top: 20px;
	margin-left: 160px;
}
</style>
  </head>
  <body>
  <div id="designMoodBoard"
  <!--------------------------------------------------------------------------------------------------------------------------->
    <div id="container"  ondrop="drop(event)" ondragover="allowDrop(event)"></div>
	<div id="buttons">
      <button id="save">
        Save Moodboard
      </button>
    </div>
	
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.6.0.min.js"></script>
    <script>
	uni_width = 120;
	var stage = new Kinetic.Stage({
		container: 'container',
		width: 450,
		height: 450
	});
    var layer = new Kinetic.Layer();
	stage.add(layer);

	function allowDrop(ev)
	{
		ev.preventDefault();
	}

	function drag(ev)
	{
		ev.dataTransfer.setData("Text", ev.target.id);
	}
	
	function drop(ev)
	{
		ev.preventDefault();
		data = ev.dataTransfer.getData("Text");
		img_received = document.getElementById(data);
		ratio = img_received.height / img_received.width;
		
		var c=document.getElementById("container");
		drop_x=event.pageX-c.offsetLeft;
		drop_y=event.pageY-c.offsetTop;
		
		var imageObj = new Image();
		imageObj.src = img_received.src;
		imageObj.onload = function() {
			var new_image = new Kinetic.Image({
			x: drop_x - uni_width / 2,
			y: drop_y - uni_width * ratio / 2,
			image: imageObj,
			src: img_received.src,
			name: "pic",
			width: uni_width,
			height: uni_width * ratio,
			draggable: true
			});
		new_image.on('mouseover', function() {
            document.body.style.cursor = 'move';
          });
        new_image.on('mouseout', function() {
            document.body.style.cursor = 'default';
          });
        // add the shape to the layer
        layer.add(new_image);
		layer.draw();
      };
	}
	
	document.getElementById('save').addEventListener('click', function() {
            json = stage.toJSON();
			console.log(json);
			var new_stage = Kinetic.Node.create(json, 'displayMoodBoard');
			
			//set image
			var images = new_stage.get('.pic');

			for(i=0;i<images.length;i++)
			{  
			//function to induce scope
			(function() {
				var new_image = images[i];
				var new_imageObj = new Image();
				new_imageObj.onload = function() {
				new_image.setImage(new_imageObj);
				new_image.getLayer().draw();
				};
				new_imageObj.src = new_image.attrs.src;
			})();
}
			
    }, false);
	  
    </script>
	<!--------------------------------------------------------------------------------------------------------------------------->
	<div id="image_menu">
		<table id="item_table" border="1px">
			<tr id="dress">
				<td><img id="dress_1" src = "images/dress_1.jpeg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="dress_2" src = "images/dress_2.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="dress_3" src ="images/dress_3.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="dress_4" src ="images/dress_4.jpg" draggable="true" ondragstart="drag(event)" /></td>
			</tr>
			<tr id="handbag">
				<td><img id="handbag_1" src = "images/handbag_1.jpeg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="handbag_2" src = "images/handbag_2.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="handbag_3" src ="images/handbag_3.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="handbag_4" src ="images/handbag_4.jpg" draggable="true" ondragstart="drag(event)" /></td>
			</tr>
			<tr id="accessory">
				<td><img id="accessory_1" src = "images/accessory_1.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="accessory_2" src = "images/accessory_2.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="accessory_3" src ="images/accessory_3.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="accessory_4" src ="images/accessory_4.jpg" draggable="true" ondragstart="drag(event)" /></td>
			</tr>
			<tr id="shoe">
				<td><img id="shoe_1" src = "images/shoe_1.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="shoe_2" src = "images/shoe_2.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="shoe_3" src ="images/shoe_3.jpg" draggable="true" ondragstart="drag(event)" /></td>
				<td><img id="shoe_4" src ="images/shoe_4.jpg" draggable="true" ondragstart="drag(event)" /></td>
			</tr>
		</table>
	</div> 
  </div>
  <div id="displayMoodBoard"></div>
  </body>
</html>